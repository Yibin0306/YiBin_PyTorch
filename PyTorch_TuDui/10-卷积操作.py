# 文档说明卷积操作的基本原理
"""
输入图像 -> 卷积核 -> 卷积后的输出
卷积为图像和卷积核相乘后相加
"""

import torch
import torch.nn.functional as F  # 导入PyTorch的函数模块，包含卷积操作

# 定义输入图像 (5x5矩阵)
# 在深度学习中，图像通常表示为二维矩阵，每个数值代表像素强度
input = torch.tensor([
    [1, 2, 0, 3, 1],
    [0, 1, 2, 3, 1],
    [1, 2, 1, 0, 0],
    [5, 2, 3, 1, 1],
    [2, 1, 0, 1, 1]
], dtype=torch.float32)  # 明确指定数据类型为float32，这是卷积操作的标准输入类型

# 定义卷积核 (3x3矩阵)
# 卷积核用于提取图像特征，不同的核可以检测边缘、纹理等特征
kernel = torch.tensor([
    [1, 2, 1],
    [0, 1, 0],
    [2, 1, 0]
], dtype=torch.float32)  # 同样指定为float32类型

# 重塑输入张量维度为PyTorch卷积要求的标准格式
# conv2d要求输入形状为 (batch_size, channels, height, width)
# 这里：1个样本，1个颜色通道，5x5图像
input = torch.reshape(input, (1, 1, 5, 5))

# 重塑卷积核维度
# conv2d要求卷积核形状为 (out_channels, in_channels, kernel_height, kernel_width)
# 这里：输出1个通道，输入1个通道，3x3卷积核
kernel = torch.reshape(kernel, (1, 1, 3, 3))

# 第一次卷积：步长(stride)为1，无填充(padding)
# stride=1 表示卷积核每次移动1个像素
output = F.conv2d(input, kernel, stride=1)
print("步长为1的卷积结果：")
print(output)
# 输出说明：
# tensor([[[[10, 12, 12],
#           [ 18, 16, 16],
#           [13, 9,  3]]]])
# 计算过程：
# 左上角: 1 * 1 + 2 * 2 + 0 * 1 + 0 * 0 + 1 * 1 + 2 * 0 + 1 * 2 + 2 * 1 + 1 * 0 = 1+4+0+0+1+0+2+2+0=10

# 第二次卷积：步长(stride)为2，无填充
# stride=2 表示卷积核每次移动2个像素，输出尺寸会减小
output2 = F.conv2d(input, kernel, stride=2)
print("\n步长为2的卷积结果：")
print(output2)
# 输出说明：
# tensor([[[[10, 12],
#           [13,  3]]]])
# 计算过程：
# 只有左上角和右下角两个位置：
# 左上角: 同上为10
# 右下角: 1 * 1 + 0 * 1 + 1 * 0 + 0 * 2 + 1 * 1 + 1 * 0 + 1 * 2 + 0 * 1 + 1 * 0 = 1+0+0+0+1+0+2+0+0=4? 
# 实际是(3,3)位置: 1 * 1 + 0 * 1 + 0 * 0 + 3 * 2 + 1 * 1 + 1 * 0 + 1 * 2 + 1 * 1 + 0 * 0 = 1+0+0+6+1+0+2+1+0=11?
# 注意：输出是(1,1,2,2)，实际计算位置是(0,0)、(0,2)、(2,0)、(2,2)

# 填充(padding)
#     在图像边缘添加0值像素
#     作用：保持输入输出尺寸相同
#     公式：输出尺寸 = (输入尺寸 + 2×填充 - 卷积核尺寸)/步长 + 1
# 第三次卷积：步长为1，填充(padding)为1
# padding=1 表示在图像周围添加一圈0，保持输出尺寸与输入相同
output3 = F.conv2d(input, kernel, stride=1, padding=1)
print("\n步长为1且填充为1的卷积结果：")
print(output3)
# 左上角: 0 * 1 + 0 * 2 + 0 * 1 + 0 * 0 + 1 * 1 + 2 * 0 + 0 * 2 + 1 * 1 + 2 * 0 = 0+0+0+0+1+0+0+1+0=2?
# 实际计算左上角(0,0)位置时，卷积核覆盖的是填充区域和原始图像的左上角部分